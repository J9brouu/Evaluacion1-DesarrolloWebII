<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Crear pedido — GameInventory</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
  </head>
  <body class="bg-gradient">
    <header th:replace="fragments/navbar :: navbar"></header>

    <main class="container my-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div th:if="${pedido.id == null}">
                <h5 class="card-title mb-0">Crear pedido</h5>
            </div>
            <div th:if="${pedido.id != null}">
                <h5 class="card-title mb-0">Editar pedido</h5>
            </div>
            <a class="btn btn-outline-secondary" th:href="${user != null and (#strings.toLowerCase(user.rol) == 'admin' or #strings.toLowerCase(user.rol) == 'administrator')} ? @{/pedidos/listar} : @{/pedidos/mis}"><i class="bi bi-arrow-left"></i> Volver</a>
          </div>

          <form th:action="@{/pedidos/save}" th:object="${pedido}" method="post" class="row g-3">
            <input type="hidden" name="juegoId" th:value="${juego != null ? juego.id : ''}" id="juegoIdHidden" />
            <div th:if="${juegos != null}">
              <label for="juegoSelect" class="form-label">Seleccionar juego (opcional)</label>
              <select id="juegoSelect" class="form-select mb-3">
                <option value="">-- Ninguno --</option>
                <option th:each="jg : ${juegos}"
                        th:value="${jg.id}"
                        th:data-stock="${jg.stock}"
                        th:data-title="${jg.titulo}"
                        th:text="${jg.titulo + ' (' + jg.plataforma + ') - Stock: ' + (jg.stock != null ? jg.stock : 0)}"
                        th:selected="${juego != null} ? ${jg.id} == ${juego.id} : false">
                </option>
              </select>
            </div>
            <input type="hidden" th:field="*{id}">
            <input type="hidden" th:field="*{createAt}">

            <div class="row g-3">
              <div class="col-md-8">
                <label for="producto" class="form-label">Producto / Descripción</label>
                <input type="text" class="form-control" id="producto" th:field="*{producto}" placeholder="Ej: God of War, The Last of Us..." required>
                <div th:if="${juego != null}" class="mt-2">
                  <div class="card p-2">
                    <strong th:text="${juego.titulo}"></strong>
                    <div><small class="text-muted">Plataforma: <span th:text="${juego.plataforma}"></span></small></div>
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <label for="cantidad" class="form-label">Cantidad</label>
                <input type="number" class="form-control" id="cantidad" th:field="*{cantidad}" placeholder="1" required
                  min="1" th:attr="max=${juego != null ? juego.stock : ''}" />
                <div th:if="${juego != null}" class="form-text">Stock disponible: <span th:text="${juego.stock}">0</span></div>
                <div id="cantidadError" class="alert alert-danger mt-2 d-none" role="alert"></div>
              </div>
            </div>
             

            <div class="col-md-12">
              <div th:if="${user != null and (#strings.toLowerCase(user.rol) == 'admin' or #strings.toLowerCase(user.rol) == 'administrator')}">
                <label for="usuarioId" class="form-label">Cliente</label>
                <select class="form-select" id="usuarioId" name="usuarioId.id" th:field="*{usuarioId.id}" required>
                  <option value="">Seleccione un cliente...</option>
                  <option th:each="u : ${usuarios}" th:value="${u.id}" th:text="${u.nombre + ' ' + u.apellido}"></option>
                </select>
              </div>
              <div th:if="${user != null and not (#strings.toLowerCase(user.rol) == 'admin' or #strings.toLowerCase(user.rol) == 'administrator')}">
                <input type="hidden" th:field="*{usuarioId.id}" th:value="${pedido.usuarioId != null ? pedido.usuarioId.id : ''}" />
              </div>
            </div>

           

            <div class="col-12 d-flex justify-content-end gap-2 mt-3">
                <div th:if="${pedido.id == null}">
              <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Crear pedido</button>
            </div>
            <div th:if="${pedido.id != null}">
              <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Guardar cambios</button>
            </div>
            <a class="btn btn-secondary" th:href="${user != null and (#strings.toLowerCase(user.rol) == 'admin' or #strings.toLowerCase(user.rol) == 'administrator') } ? @{/pedidos/listar} : @{/pedidos/mis}">Cancelar</a>
            </div>
          </form>
          <script>
            (function(){
              const form = document.currentScript.previousElementSibling;
              const cantidadInput = document.getElementById('cantidad');
              const errorDiv = document.getElementById('cantidadError');
              const juegoSelect = document.getElementById('juegoSelect');
              const juegoIdHidden = document.getElementById('juegoIdHidden');
              const productoInput = document.getElementById('producto');

              // si hay selector de juego, al cambiar sincronizar hidden, producto y max
              if (juegoSelect) {
                juegoSelect.addEventListener('change', function(){
                  const opt = juegoSelect.options[juegoSelect.selectedIndex];
                  const val = juegoSelect.value;
                  if (val) {
                    const title = opt.getAttribute('data-title') || '';
                    const stock = opt.getAttribute('data-stock');
                    juegoIdHidden.value = val;
                      if (title) {
                        productoInput.value = title;
                        // marcar/lockear el campo producto cuando se elige un juego
                        productoInput.setAttribute('readonly', 'readonly');
                      }
                    if (stock !== null && stock !== undefined && cantidadInput) {
                      cantidadInput.setAttribute('max', stock);
                    }
                  } else {
                    juegoIdHidden.value = '';
                    // quitar max cuando no hay juego seleccionado
                    if (cantidadInput) cantidadInput.removeAttribute('max');
                    // permitir editar producto manualmente cuando no hay juego seleccionado
                    if (productoInput) productoInput.removeAttribute('readonly');
                  }
                });
                // disparar evento inicial para aplicar estado cuando la página carga con juego preseleccionado
                const ev = new Event('change');
                juegoSelect.dispatchEvent(ev);
              }
              form.addEventListener('submit', function(e){
                if(!cantidadInput) return;
                const val = Number(cantidadInput.value);
                const min = Number(cantidadInput.getAttribute('min')) || 1;
                const max = cantidadInput.getAttribute('max') ? Number(cantidadInput.getAttribute('max')) : null;
                if(isNaN(val) || val < min){
                  e.preventDefault();
                  errorDiv.classList.remove('d-none');
                  errorDiv.textContent = 'La cantidad debe ser un número entero mayor o igual a ' + min + '.';
                  cantidadInput.focus();
                  return false;
                }
                if(max !== null && val > max){
                  e.preventDefault();
                  errorDiv.classList.remove('d-none');
                  errorDiv.textContent = 'La cantidad solicitada excede el stock disponible (' + max + ').';
                  cantidadInput.focus();
                  return false;
                }
                // valid
                errorDiv.classList.add('d-none');
              });
            })();
          </script>
        </div>
      </div>
    </main>

    <div th:replace="fragments/footer :: footer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
